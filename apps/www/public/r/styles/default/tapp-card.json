{
  "name": "tapp-card",
  "type": "registry:ui",
  "dependencies": [
    "wagmi",
    "@frames.js/render",
    "@neynar/react"
  ],
  "shadcnDependencies": [
    "card",
    "skeleton"
  ],
  "files": [
    {
      "path": "ui/tapp-card.tsx",
      "content": "\"use client\";\nimport React, {\n  useRef,\n  useState,\n  RefObject,\n  useEffect,\n  useMemo,\n  useCallback,\n} from \"react\";\nimport {\n  useAccount,\n  useReadContracts,\n  useWalletClient,\n  useConnect,\n  useConnectors,\n} from \"wagmi\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { cn } from \"@/registry/default/lib/utils\";\nimport { useFarcasterIdentity } from \"@frames.js/render/identity/farcaster\";\nimport { useFrame } from \"@frames.js/render/use-frame\";\nimport {\n  fallbackFrameContext,\n  OnTransactionArgs,\n  signFrameAction,\n} from \"@frames.js/render\";\nimport {\n  FrameUI,\n  type FrameUIComponents,\n  type FrameUITheme,\n} from \"@frames.js/render/ui\";\nimport { WebStorage } from \"@frames.js/render/identity/storage\";\nimport { NeynarContextProvider, Theme, useNeynarContext } from \"@neynar/react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\n\nconst ERC5169_ABI = [\n  {\n    inputs: [],\n    name: \"scriptURI\",\n    outputs: [\n      {\n        internalType: \"string[]\",\n        name: \"\",\n        type: \"string[]\",\n      },\n    ],\n    stateMutability: \"view\",\n    type: \"function\",\n  },\n] as const;\n\nexport function TappCardSkeleton(props: { className?: string }) {\n  return (\n    <Card className={cn(\"w-[350px] overflow-hidden\", props.className)}>\n      <CardHeader className=\"p-0\">\n        <Skeleton className=\"w-full h-[200px]\" />\n      </CardHeader>\n      <CardContent className=\"p-4\">\n        <Skeleton className=\"h-8 w-3/4 mb-2\" />\n        <Skeleton className=\"h-4 w-full mb-4\" />\n        <div className=\"grid grid-cols-2 gap-x-4 gap-y-2\">\n          {[...Array(3)].map((_, index) => (\n            <div key={index} className=\"flex flex-col\">\n              <Skeleton className=\"h-4 w-20 mb-1\" />\n              <Skeleton className=\"h-5 w-28\" />\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface TappCardProps {\n  chainId: number;\n  contract: `0x${string}`;\n  tokenId: string;\n  scriptURI?: string;\n  cssClass?: string;\n}\n\nexport default function TappCard({\n  chainId,\n  contract,\n  tokenId,\n  cssClass,\n}: TappCardProps) {\n  const [scriptURI, setScriptURI] = useState<string | null>(null);\n  const [viewerType, setViewerType] = useState<string | null>(null);\n\n  const { data } = useReadContracts({\n    allowFailure: false,\n    contracts: [\n      {\n        chainId,\n        address: contract,\n        abi: ERC5169_ABI,\n        functionName: \"scriptURI\",\n        args: [],\n      },\n    ],\n  });\n\n  useEffect(() => {\n    if (data?.[0]) {\n      if (data?.[0].length > 0) {\n        setScriptURI(data[0] as unknown as string);\n        const parsedURI = new URL(data[0] as unknown as string);\n        setViewerType(\n          parsedURI.hostname.startsWith(\"viewer\") ? \"ts\" : \"farcaster\",\n        );\n      } else {\n        throw new Error(\"No scriptURI\");\n      }\n    }\n  }, [data]);\n\n  if (!scriptURI) {\n    return <TappCardSkeleton />;\n  }\n\n  return viewerType === \"ts\" ? (\n    <TsViewer\n      chainId={chainId}\n      contract={contract}\n      tokenId={tokenId}\n      cssClass={cssClass}\n    />\n  ) : (\n    <>\n      <NeynarContextProvider\n        settings={{\n          clientId: process.env.NEXT_PUBLIC_NEYNAR_CLIENT_ID || \"\",\n          defaultTheme: Theme.Light,\n          eventsCallbacks: {\n            onAuthSuccess: () => {},\n            onSignout() {},\n          },\n        }}\n      >\n        <FarcasterFrame\n          chainId={chainId}\n          contract={contract}\n          tokenId={tokenId}\n          scriptURI={scriptURI}\n        />\n      </NeynarContextProvider>\n    </>\n  );\n}\n\nexport function TsViewer({\n  chainId,\n  contract,\n  tokenId,\n  cssClass,\n}: TappCardProps) {\n  const [isLoaded, setIsLoaded] = useState(false);\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const url = `https://viewer-staging.tokenscript.org/?viewType=sts-token&chain=${chainId}&contract=${contract}&tokenId=${tokenId}`;\n  useIframePostMessage(iframeRef, url);\n\n  const handleIframeLoad = () => {\n    setIsLoaded(true);\n  };\n\n  return (\n    <>\n      {!isLoaded && <TappCardSkeleton />}\n      <iframe\n        ref={iframeRef}\n        src={url}\n        className={cn(\n          \"mx-auto h-[650px] max-w-[500px] w-full iframe-placeholder\",\n          cssClass,\n        )}\n        onLoad={handleIframeLoad}\n      ></iframe>\n    </>\n  );\n}\n\nexport function FarcasterFrame({\n  chainId,\n  contract,\n  tokenId,\n  scriptURI,\n}: TappCardProps) {\n  type StylingProps = {\n    className?: string;\n    style?: React.CSSProperties;\n  };\n\n  const components: FrameUIComponents<StylingProps> = {};\n\n  const theme: FrameUITheme<StylingProps> = {\n    Root: {\n      className:\n        \"flex flex-col max-w-[600px] gap-2 border rounded-lg ovrflow-hidden bg-white relative\",\n    },\n    LoadingScreen: {\n      className: \"absolute top-0 left-0 right-0 bottom-0 bg-gray-300 z-10\",\n    },\n    ImageContainer: {\n      className: \"relative w-full border-b border-gray-300 overflow-hidden\",\n      style: {\n        aspectRatio: \"var(--frame-image-aspect-ratio)\",\n      },\n    },\n    ButtonsContainer: {\n      className: \"flex justify-evenly space-x-2 px-2 pb-2\",\n    },\n    Button: {\n      className:\n        \"bg-gray-100 border-gray-200 flex items-center justify-center flex-row text-sm rounded-lg border cursor-pointer gap-1.5 h-10 py-2 px-4 w-full \",\n    },\n  };\n  const { user } = useNeynarContext();\n  const connectors = useConnectors();\n  const { connect } = useConnect();\n  const { address } = useAccount();\n  const { data: walletClient } = useWalletClient();\n  const [error, setError] = useState<string | null>(null);\n  const [txHash, setTxHash] = useState<string | null>(null);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [dialogContent, setDialogContent] = useState({\n    title: \"\",\n    description: \"\",\n    link: \"\",\n  });\n  const storage = useMemo(() => new WebStorage(), []);\n  const signerState = useFarcasterIdentity({\n    storage,\n    onMissingIdentity: useCallback(() => {\n      if (user && typeof user === \"object\" && user.fid) {\n        return signerState.impersonateUser(user.fid);\n      }\n      return signerState.createSigner();\n    }, [user]),\n  });\n\n  const frameConfig = useMemo(\n    () => ({\n      homeframeUrl: scriptURI,\n      frameActionProxy:\n        process.env.NEXT_PUBLIC_FRAME_RENDER_URL ||\n        \"http://localhost:3000/frames\",\n      frameGetProxy:\n        process.env.NEXT_PUBLIC_FRAME_RENDER_URL ||\n        \"http://localhost:3000/frames\",\n      frameContext: fallbackFrameContext,\n      signerState,\n      signFrameAction,\n      connectedAddress: address,\n      async onConnectWallet() {\n        try {\n          const connector = connectors[0];\n          connect({ connector, chainId: chainId });\n        } catch (error) {\n          console.error(\"Error for connect wallet:\", error);\n          setError(\"Error for connect wallet\");\n        }\n      },\n      async onTransaction(arg: OnTransactionArgs) {\n        try {\n          setError(\"\");\n          if (!address) {\n            throw new Error(\"No wallet connected\");\n          }\n\n          if (!walletClient) {\n            throw new Error(\"Can't get the wallet client.\");\n          }\n\n          if (!arg.transactionData || typeof arg.transactionData !== \"object\") {\n            throw new Error(\"Wrong transactioin data.\");\n          }\n\n          const { params } = arg.transactionData;\n\n          const txHash = await walletClient.sendTransaction({\n            account: address,\n            to: params.to as `0x${string}`,\n            data: params.data as `0x${string}`,\n            gas: BigInt(6000000),\n            value: BigInt(params.value ?? 0),\n          });\n\n          setTxHash(txHash);\n\n          return txHash;\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            if (error.message.includes(\"rejected\")) {\n              setError(\"User rejected the transaction.\");\n            } else {\n              setError(\"Error for wallet, please check wallet or refresh\");\n            }\n          } else {\n            setError(String(error));\n          }\n          throw error;\n        }\n      },\n      onLinkButtonClick(event: {\n        action: string;\n        label: string;\n        target: string;\n      }) {\n        setDialogContent({\n          title: \"Confirm\",\n          description: `Do you confirm to open the link: ${event.target}`,\n          link: event.target,\n        });\n        setDialogOpen(true);\n      },\n    }),\n    [chainId, contract, tokenId, signerState],\n  );\n\n  const frameState = useFrame(frameConfig);\n\n  return (\n    <>\n      <FrameUI frameState={frameState} components={components} theme={theme} />\n      {error && (\n        <div className=\"text-red-500 mb-4 p-2 bg-red-100 rounded mt-4 max-w-[600px] break-words\">\n          Error: {error}\n        </div>\n      )}\n      {txHash && (\n        <div className=\"text-green-500 mb-4 p-2 bg-green-100 rounded mt-4 max-w-[600px] break-words\">\n          Transaction is submitted. For more details, please access:\n          <a\n            href={`${getBlockExplorerUrl(chainId)}/tx/${txHash}`}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"underline\"\n          >\n            {txHash}\n          </a>\n        </div>\n      )}\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{dialogContent.title}</DialogTitle>\n            <DialogDescription>{dialogContent.description}</DialogDescription>\n          </DialogHeader>\n          <div className=\"flex justify-end space-x-2\">\n            <Button variant=\"outline\" onClick={() => setDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                window.open(dialogContent.link);\n                setDialogOpen(false);\n              }}\n            >\n              Confirm\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\nfunction getBlockExplorerUrl(chainId: number): string {\n  switch (chainId) {\n    case 1:\n      return \"https://etherscan.io\";\n    case 5:\n      return \"https://goerli.etherscan.io\";\n    case 11155111:\n      return \"https://sepolia.etherscan.io\";\n    case 137:\n      return \"https://polygonscan.com\";\n    case 80001:\n      return \"https://mumbai.polygonscan.com\";\n    case 56:\n      return \"https://bscscan.com\";\n    case 97:\n      return \"https://testnet.bscscan.com\";\n    case 42161:\n      return \"https://arbiscan.io\";\n    case 421613:\n      return \"https://goerli.arbiscan.io\";\n    case 10:\n      return \"https://optimistic.etherscan.io\";\n    case 420:\n      return \"https://goerli-optimism.etherscan.io\";\n    case 8453:\n      return \"https://basescan.org\";\n    case 84532:\n      return \"https://sepolia.basescan.org\";\n    default:\n      return \"https://etherscan.io\";\n  }\n}\n\nexport const useIframePostMessage = (\n  iframeRef: RefObject<HTMLIFrameElement>,\n  targetOrigin: string,\n) => {\n  const { data: walletClient } = useWalletClient();\n\n  useEffect(() => {\n    function sendResponse(\n      messageData: MessageEvent[\"data\"],\n      response: unknown,\n      error?: unknown,\n    ) {\n      const data = messageData;\n\n      if (error) {\n        data.error = error;\n      } else {\n        data.result = response;\n      }\n\n      iframeRef.current?.contentWindow?.postMessage(data, \"*\");\n    }\n\n    const handleMessage = async (event: MessageEvent) => {\n      if (!walletClient) {\n        return;\n      }\n\n      if (!event.data.method) {\n        return;\n      }\n\n      try {\n        switch (event.data.method) {\n          case \"eth_accounts\":\n          case \"eth_requestAccounts\": {\n            const data = await walletClient.request({\n              method: event.data.method,\n            });\n            sendResponse(event.data, data);\n            break;\n          }\n          case \"eth_getCode\":\n          case \"eth_chainId\":\n          case \"net_version\":\n          case \"eth_blockNumber\":\n          case \"eth_estimateGas\":\n          case \"eth_sendTransaction\":\n          case \"eth_getTransactionByHash\":\n          case \"eth_getTransactionReceipt\":\n          case \"eth_getTransactionCount\":\n          case \"personal_sign\":\n          case \"eth_call\":\n          case \"eth_signTypedData\":\n          case \"eth_signTypedData_v4\":\n          case \"eth_getBlockByNumber\":\n          case \"wallet_switchEthereumChain\": {\n            const data = await walletClient.request({\n              method: event.data.method,\n              params: event.data.params,\n            });\n            sendResponse(event.data, data);\n            break;\n          }\n\n          default:\n            sendResponse(event.data, null, {\n              code: -1,\n              message:\n                \"RPC Method \" + event.data.method + \" is not implemented\",\n            });\n            break;\n        }\n      } catch (e: unknown) {\n        const error = e as CustomError;\n\n        sendResponse(event.data, null, {\n          code: error.data?.code ?? error.code,\n          message:\n            error.message +\n            (error.data?.message ? \" \" + error.data?.message : \"\"),\n        });\n      }\n    };\n\n    window.addEventListener(\"message\", handleMessage);\n\n    return () => window.removeEventListener(\"message\", handleMessage);\n  }, [iframeRef, targetOrigin, walletClient]);\n};\n\ninterface CustomError extends Error {\n  data?: { code?: number; message?: string };\n  code?: number;\n}\n",
      "type": "registry:ui",
      "target": ""
    }
  ]
}